---
title: "Honours Analysis 2025 - Flexibility Experiment"
format: html
code-fold: true
code-summary: "Show code"
embed-resources: true
editor: visual
execute-dir: project
execute: 
  warning: false
  message: false
---

Load libraries and import data

```{r}
#| output: false

# load libraries
library(afex)
library(emmeans)
library(data.table)
library(ggpubr)
library(tidyverse)
library(stringr)

# set emmeans option to multivariate
afex_options(emmeans_model = "multivariate") # use multivariate for RM designs

# assign experiment label
exp <- 'flex'

# load data
avg_flex <- fread('data/exp-flex_avg.csv')
avg_flex_ss <- fread('data/exp-flex_avg-ss.csv')

# change factor level names
avg_flex[, switch := ifelse(switch==0, 'non-switch', 'switch')]
avg_flex[, train_type := ifelse(train_type==1,'stable', 'variable')]
avg_flex[, ses := ifelse(ses==2, 'training', 'testing')]

# change factor level names
avg_flex_ss[, subses := ifelse(subses==1, 'first', 'last')]
avg_flex_ss[, switch := ifelse(switch==0, 'non-switch', 'switch')]
avg_flex_ss[, train_type := ifelse(train_type==1,'stable', 'variable')]
avg_flex_ss[, ses := ifelse(ses==2, 'training', 'testing')]
```

## Testing session

```{r}
# assign session label
ses <- 'test'
```

Define contrasts for analysis

```{r}
## define contrasts for analysis
# effect of switch at each level of train_type
switch_vs_nonswitch <- list(stable = c(-1, 0, 1, 0),
                            variable = c(0, -1, 0, 1))
# effect of train_type at each level of switch, plus main effect of train_type
stable_vs_variable <- list(nonswitch = c(1, -1, 0, 0),
                           switch = c(0, 0, 1, -1))
# interaction effect
interaction <- list(interaction = c(0.5, -0.5, -0.5, 0.5))

list_of_contrast_lists <- list(interaction,
                               switch_vs_nonswitch, 
                               stable_vs_variable)
```

Write a function that automatically applies contrasts to a table of emms.

```{r}
# a function to rule them all
get_all_contrasts <- function(this_dv, list_of_contrast_lists){
  
  # specify model
  mdl <- aov_ez(id = 'sub',
                within = 'switch', 
                between = 'train_type',
                dv = this_dv,
                data = avg_flex[ses=='testing'])

  # generate means
  emm_int <- emmeans(mdl, c("train_type", "switch"))
  
    # plot 
  p <- afex_plot(mdl, 
          x = 'switch', 
          trace = 'train_type', 
          error = "none", 
          data_plot = F) + 
  theme_pubclean()
  
  # compute contrasts
  c <- do.call(rbind, lapply(list_of_contrast_lists, function(x) summary(contrast(emm_int, x, adjust='bonferroni'))))
  
  # put result in data frame
  dt <- data.table(c)
  dt[, names(.SD) := lapply(.SD, round, 2), .SDcols=c('estimate', 'SE', 'df', 't.ratio')
  ][, names(.SD) := lapply(.SD, round, 3), .SDcols=c('p.value')]

  # return output
  return(list(means=emm_int, plot=p, contrasts=c, dt=dt)) #made this return some additional information for interpreting the results
}
```

### Accuracy

```{r}
# assign variable label
var <- 'accuracy_mean'

# compute contrasts
res <- get_all_contrasts(var, list_of_contrast_lists)

# show results
res$contrasts
res$plot

# save result
fln <- str_glue("res/contrasts_exp-{exp}_ses-{ses}_{var}.csv")
write_csv(res$dt, fln)
```

### Setting errors

```{r}
# assign variable label
var <- 'setting_errors_mean'

# compute contrasts
res <- get_all_contrasts(var, list_of_contrast_lists)

# show results
res$contrasts
res$plot

# save result
fln <- str_glue("res/contrasts_exp-{exp}_ses-{ses}_{var}.csv")
write_csv(res$dt, fln)
```

### General errors

```{r}
# assign variable label
var <- 'general_errors_mean'

# compute contrasts
res <- get_all_contrasts(var, list_of_contrast_lists)

# show results
res$contrasts
res$plot

# save result
fln <- str_glue("res/contrasts_exp-{exp}_ses-{ses}_{var}.csv")
write_csv(res$dt, fln)
```

### RT first correct

```{r}
# assign variable label
var <- 'rt_first_correct_mean'

# compute contrasts
res <- get_all_contrasts(var, list_of_contrast_lists)

# show results
res$contrasts
res$plot

# save result
fln <- str_glue("res/contrasts_exp-{exp}_ses-{ses}_{var}.csv")
write_csv(res$dt, fln)
```
### LISAS - First correct

```{r}
# assign variable label
var <- 'LISAS_rt_fst_cor'

# compute contrasts
res <- get_all_contrasts(var, list_of_contrast_lists)

# show results
res$contrasts
res$plot

# save result
fln <- str_glue("res/contrasts_exp-{exp}_ses-{ses}_{var}.csv")
write_csv(res$dt, fln)
```

### RT subs correct

Add main effect contrasts for RT subs correct variables
```{r}
# add main effect contrasts and redefine list of contrasts
stable_vs_variable <- list(nonswitch = c(1, -1, 0, 0),
                           switch = c(0, 0, 1, -1),
                           main = c(-0.5, 0.5, -0.5, 0.5))
list_of_contrast_lists <- list(interaction,
                               switch_vs_nonswitch, 
                               stable_vs_variable)
# compute contrasts
```

```{r}
# assign variable label
var <- 'rt_subs_correct_mean'

res <- get_all_contrasts(var, list_of_contrast_lists)

# show results
res$contrasts
res$plot

# save result
fln <- str_glue("res/contrasts_exp-{exp}_ses-{ses}_{var}.csv")
write_csv(res$dt, fln)
```

### LISAS - Subs correct

```{r}
# assign variable label
var <- 'LISAS_rt_sub_cor'

# compute contrasts
res <- get_all_contrasts(var, list_of_contrast_lists)

# show results
res$contrasts
res$plot

# save result
fln <- str_glue("res/contrasts_exp-{exp}_ses-{ses}_{var}.csv")
write_csv(res$dt, fln)
```

## Training session

```{r}
ses <- 'train'
```

Define contrasts for analysis

```{r}
# look at effect of sub_ses at each level of train_type
first_vs_last <- list(stable = c(-1, 0, 1, 0),
                      variable = c(0, -1, 0, 1))
# look at effect of train_type at each level of sub_ses
stable_vs_variable <- list(first = c(1, -1, 0, 0),
                           last = c(0, 0, 1, -1))
# interaction effect
interaction <- list(interaction = c(0.5, -0.5, -0.5, 0.5))

# combine
list_of_contrast_lists <- list(interaction,
                               first_vs_last, 
                               stable_vs_variable)
```

Edit the contrast function.

```{r}
# a function to rule them all
get_all_contrasts <- function(this_dv, list_of_contrast_lists){
  
  # specify model
  mdl <- aov_ez(id = 'sub',
              within = 'subses', 
              between = 'train_type',
              dv = this_dv,
              data = avg_flex_ss[ses=='training' & switch=='non-switch'])

  # generate means
  emm_int <- emmeans(mdl, c("train_type", "subses"))
  
    # plot 
  p <- afex_plot(mdl, 
          x = 'subses', 
          trace = 'train_type', 
          error = 'none', 
          data_plot = F) + 
  theme_pubclean()
  
  # compute contrasts
  c <- do.call(rbind, lapply(list_of_contrast_lists, function(x) summary(contrast(emm_int, x, adjust='bonferroni'))))
  
  # put result in data frame
  dt <- data.table(c)
  dt[, names(.SD) := lapply(.SD, round, 2), .SDcols=c('estimate', 'SE', 'df', 't.ratio')
  ][, names(.SD) := lapply(.SD, round, 3), .SDcols=c('p.value')]

  # return output
  return(list(means=emm_int, plot=p, contrasts=c, dt=dt))
}
```

### Setting errors

```{r}
# assign variable label
var <- 'setting_errors_mean'

# compute contrasts
res <- get_all_contrasts(var, list_of_contrast_lists)

# show results
res$contrasts
res$plot

# save result
fln <- str_glue("res/contrasts_exp-{exp}_ses-{ses}_{var}.csv")
write_csv(res$dt, fln)
```

### General errors

```{r}
# assign variable label
var <- 'general_errors_mean'

# compute contrasts
res <- get_all_contrasts(var, list_of_contrast_lists)

# show results
res$contrasts
res$plot

# save result
fln <- str_glue("res/contrasts_exp-{exp}_ses-{ses}_{var}.csv")
write_csv(res$dt, fln)
```
